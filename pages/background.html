<script type="text/javascript">
	/*** Request listener ***/
	chrome.extension.onRequest.addListener(function(request, sender, sendResponse){
        switch(request.type){
            case "propSet":
                localStorage.setItem(request.prop, request.val);
                if(request.prop === "popupAction" && request.val === "popup"){
                    chrome.browserAction.setPopup({"popup": "pages/popup.html"});
                }else{
                    chrome.browserAction.setPopup({"popup": ""});
                }
            break;
            case "propGet":
                 sendResponse(localStorage);
            break;
            case "popupLink":
                 createTab(request.payload, "url");
            break;
            default: //snub
                sendResponse({});
        }
	});

	/*** BrowserAction listener ***/
    //only hit if no popup is set
	chrome.browserAction.onClicked.addListener(function(tab) {
        var mode = localStorage.getItem("popupAction");
        switch(mode){
            case "blank":
                createTab();
            break;
            case "url":
                createTab(tab.url, "url");
            break;

        }
	});
	
	/*** Context Menu ***/
	chrome.contextMenus.create({
		title: "JsonReport",
		contexts: ["link", "selection"],
		onclick: function(info, tab){
            if(info.linkUrl){
                createTab(info.linkUrl, "url");
            }else{
                createTab(info.selectionText, "text");
            }

		}
	});

    /*** Init ***/
    if(!localStorage.getItem("init")){
        var defaults = {
            "popupAction": "popup",
            "storeHistory": true,
            "autoJson": true
        }
        for(prop in defaults){
            localStorage.setItem(prop, defaults[prop]);
        }
        localStorage.setItem("init", true);
    }

    /*** Create a new tab ***/
	createTab = function(payload, format){
        if(payload === "options"){
            //open a new report page
		    chrome.tabs.create({"url": chrome.extension.getURL("pages/options.html")});
        }else{
            //open a new report page
		    chrome.tabs.create({"url": chrome.extension.getURL("pages/main.html")}, function(tab){
                chrome.extension.sendRequest({
                    "type": "reportThis",
                    "tab": tab.id,
                    "payload": payload,
                    "format": format
                });
            });
        }
	}

</script>
